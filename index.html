<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
  <!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyByVvMLoofMMX82lT7r8zaJa3rSzDS9tjI",
    authDomain: "skibidi-ent.firebaseapp.com",
    databaseURL: "https://skibidi-ent-default-rtdb.firebaseio.com",
    projectId: "skibidi-ent",
    storageBucket: "skibidi-ent.appspot.com",
    messagingSenderId: "677948546573",
    appId: "1:677948546573:web:cf42efd3386dd7047c3f44"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
</script>

<title>SKIBIDI ENT üîµ</title>

<style>
body{font-family:Arial;background:#e8f0ff;margin:0}
header{background:#0b5ed7;color:white;padding:10px;text-align:center;font-size:24px}
.box{max-width:1000px;margin:20px auto;background:white;border-radius:10px;padding:15px}
button{background:#0b5ed7;color:white;border:none;padding:6px 10px;border-radius:5px;margin:2px}
.tab{display:inline-block;margin:5px;padding:6px 10px;background:#cfe2ff;border-radius:5px;cursor:pointer}
.tab.active{background:white;border-bottom:3px solid #0b5ed7}
.star{color:gold;font-size:18px}
.trash{cursor:pointer;color:red}
textarea{width:300px;height:50px;display:block;margin-top:5px;margin-bottom:5px}
</style>
</head>

<body>

<header>üìö SKIBIDI ENT üîµ</header>

<div class="box" id="login">
  <h3>Connexion</h3>
  <input id="id" placeholder="Identifiant">
  <input id="pw" type="password" placeholder="Mot de passe">
  <button onclick="connect()">Se connecter</button>
  <p id="err" style="color:red"></p>
</div>

<div class="box" id="app" style="display:none">
  <div id="tabs"></div>
  <div id="content"></div>
</div><script>

/* =========================
   UTILISATEURS
========================= */

const users={
  sahli:{pass:"sahli123",role:"prof",name:"M. Sahli"},
  bouhmadi:{pass:"bouhmadi123",role:"prof",name:"M. Bouhmadi"},
  ouachaou:{pass:"secretaire",role:"secretaire",name:"M. Ouachaou"},
  nassim:{pass:"nassim",role:"eleve",name:"Nassim"},
  arthur:{pass:"arthur",role:"eleve",name:"Arthur"},
  sarah:{pass:"sarah",role:"eleve",name:"Sarah"},
  rayan:{pass:"rayan",role:"eleve",name:"Rayan"},
  nathan:{pass:"nathan",role:"eleve",name:"Nathan"},
  aymend:{pass:"aymend",role:"eleve",name:"Aymen Dib"},
  aymenf:{pass:"aymenf",role:"eleve",name:"Aymen Ferhane"},
  nael:{pass:"nael",role:"eleve",name:"Nael"}
};

let current = null;
let data = {};

/* =========================
   FIREBASE LISTENER
========================= */

db.ref("/").on("value", snap => {
  data = snap.val() || {};

  if(!data.notes) data.notes = {};
  if(!data.stars) data.stars = {};
  if(!data.appel) data.appel = {};
  if(!data.validation) data.validation = {};
  if(!data.missions) data.missions = [];
  if(!data.edtCancel) data.edtCancel = {};
  if(!data.mots) data.mots = {};
});

/* =========================
   EMPLOI DU TEMPS
========================= */

const edt={
  "Lundi":["10h05-10h25","15h00-15h20"],
  "Mardi":["10h05-10h25"],
  "Mercredi":["10h05-10h25"],
  "Jeudi":["10h05-10h25","15h00-15h20"],
  "Vendredi":["10h05-10h25"]
};

/* =========================
   FONCTIONS GENERALES
========================= */

function save(){
  db.ref("/").set(data);
}

function eleves(){
  return Object.keys(users).filter(u=>users[u].role=="eleve");
}

/* =========================
   CONNEXION
========================= */

function connect(){
  if(!users[id.value] || users[id.value].pass!=pw.value){
    err.textContent="Erreur";
    return;
  }

  current=id.value;
  login.style.display="none";
  app.style.display="block";
  buildTabs();
}

/* =========================
   TABS
========================= */

function buildTabs(){
  let r=users[current].role;

  let t=["Notes","√âtoiles","Missions","Emploi du temps","Appel"];

  if(r=="secretaire") t=["Justification"];

  if(r=="prof" || current=="sahli" || r=="eleve") 
    t.push("Mots");

  let h="";
  t.forEach(x=>h+=`<span class="tab" onclick="openTab('${x}')">${x}</span>`);

  tabs.innerHTML=h;
  openTab(t[0]);
}

function openTab(n){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  [...tabs.children].find(x=>x.textContent==n).classList.add("active");

  if(n=="Notes") notesTab();
  if(n=="√âtoiles") starsTab();
  if(n=="Missions") missionsTab();
  if(n=="Emploi du temps") edtTab();
  if(n=="Appel") appelTab();
  if(n=="Justification") justifTab();
  if(n=="Mots") buildMotTab();
}
/* =========================
   NOTES
========================= */

function notesTab(){
  let h="<h3>üìä Notes</h3>";

  // Prof peut ajouter une note
  if(users[current].role=="prof"){
    h+=`
      <select id="noteEleve">
        ${eleves().map(e=>`<option value="${e}">${users[e].name}</option>`).join("")}
      </select>
      <input id="noteValeur" placeholder="15/20">
      <button onclick="addNote()">‚ûï</button>
      <button onclick="resetNotes()">üóëÔ∏è Reset</button>
    `;
  }

  h+="<ul>";

  eleves().forEach(e=>{
    if(data.notes[e]){
      if(current==e || users[current].role!="eleve"){
        data.notes[e].forEach((n,i)=>{
          h+=`<li>
                ${users[e].name} : ${n}
                ${users[current].role=="prof"
                  ? `<span class="trash" onclick="delNote('${e}',${i})">üóëÔ∏è</span>`
                  : ""
                }
              </li>`;
        });
      }
    }
  });

  h+="</ul>";

  content.innerHTML=h;
}

function addNote(){
  const e=document.getElementById("noteEleve").value;
  const v=document.getElementById("noteValeur").value.trim();
  if(!v) return;

  if(!data.notes[e]) data.notes[e]=[];
  data.notes[e].push(v);

  save();
  notesTab();
}

function delNote(e,i){
  data.notes[e].splice(i,1);
  save();
  notesTab();
}

function resetNotes(){
  if(confirm("Supprimer toutes les notes ?")){
    data.notes={};
    save();
    notesTab();
  }
}
/* =========================
   MISSIONS
========================= */

function missionsTab(){
  let h = "<h3>üìö Missions</h3>";

  // Si c'est un prof ‚Üí bouton ajouter
  if(users[current].role=="prof"){
    h += `
      <input id="missionInput" placeholder="Nouvelle mission">
      <button onclick="addMission()">‚ûï</button>
    `;
  }

  h += "<ul>";

  if(data.missions && data.missions.length > 0){
    data.missions.forEach((m,i)=>{
      h += `
        <li>
          ${m}
          ${users[current].role=="prof"
            ? `<span class="trash" onclick="delMission(${i})">üóëÔ∏è</span>`
            : ""
          }
        </li>
      `;
    });
  } else {
    h += "<li>Aucune mission pour le moment.</li>";
  }

  h += "</ul>";

  content.innerHTML = h;
}

function addMission(){
  const input = document.getElementById("missionInput");
  const texte = input.value.trim();

  if(!texte) return alert("√âcris une mission !");

  if(!data.missions) data.missions = [];

  data.missions.push(texte);

  save();
  missionsTab();
}

function delMission(index){
  if(confirm("Supprimer cette mission ?")){
    data.missions.splice(index,1);
    save();
    missionsTab();
  }
}/* =========================
   EMPLOI DU TEMPS
========================= */

function edtTab(){
  let h = "<h3>üóìÔ∏è Emploi du temps</h3>";
  h += "<ul>";

  for(let jour in edt){

    let annule = data.edtCancel && data.edtCancel[jour];

    h += "<li>";
    h += "<strong>" + jour + "</strong> : ";

    if(annule){
      h += "‚ùå Annul√©";
    } else {
      h += edt[jour].join(" / ");
    }

    // Boutons seulement pour les profs
    if(users[current].role == "prof"){
      if(annule){
        h += ` <button onclick="retablirJour('${jour}')">üîÑ</button>`;
      } else {
        h += ` <button onclick="annulerJour('${jour}')">‚ùå</button>`;
      }
    }

    h += "</li>";
  }

  h += "</ul>";

  content.innerHTML = h;
}

function annulerJour(jour){
  if(!data.edtCancel) data.edtCancel = {};

  data.edtCancel[jour] = true;
  save();
  edtTab();
}

function retablirJour(jour){
  if(data.edtCancel){
    delete data.edtCancel[jour];
  }

  save();
  edtTab();
}
/* =========================
   APPEL
========================= */

function appelTab(){
  let h="<h3>üìù Appel</h3>";

  if(users[current].role=="prof"){
    h += `
      <select id="appelEleve">
        ${eleves().map(e=>`<option value="${e}">${users[e].name}</option>`).join("")}
      </select>
      <select id="appelValeur">
        <option value="Pr√©sent">Pr√©sent</option>
        <option value="Absent">Absent</option>
        <option value="Retard">Retard</option>
      </select>
      <button onclick="setAppel()">Valider</button>
    `;
  }

  h += "<ul>";
  eleves().forEach(e=>{
    const st = data.appel && data.appel[e] ? data.appel[e] : "-";
    const val = data.validation && data.validation[e] ? data.validation[e] : "‚è≥ En attente";
    
    if(current==e || users[current].role!="eleve"){
      h += `<li>${users[e].name} : ${st} (${val})</li>`;
    }
  });
  h += "</ul>";

  content.innerHTML = h;
}

function setAppel(){
  const e = document.getElementById("appelEleve").value;
  const v = document.getElementById("appelValeur").value;

  if(!data.appel) data.appel = {};
  if(!data.validation) data.validation = {};

  data.appel[e] = v;
  data.validation[e] = "‚è≥ En attente";

  save();
  appelTab();
}

/* =========================
   JUSTIFICATION SECRETAIRE
========================= */

function justifTab(){
  let h="<h3>üìÑ Justification d'absence</h3><ul>";

  for(let e in data.appel){
    h += `<li>
            ${users[e].name} : ${data.appel[e]} 
            <button onclick="valide('${e}')">‚úÖ</button>
            <button onclick="refuse('${e}')">‚ùå</button>
          </li>`;
  }

  h += "</ul>";
  content.innerHTML = h;
}

function valide(e){
  if(!data.validation) data.validation={};
  data.validation[e] = "Valid√©";
  save();
  justifTab();
}

function refuse(e){
  if(!data.validation) data.validation={};
  data.validation[e] = "Refus√©";
  save();
  justifTab();
}

/* =========================
   MOTS DANS LE CARNET (Firebase)
========================= */

function buildMotTab(){
  let h="<h3>‚úâÔ∏è Mots dans le carnet</h3>";

  // Prof ou M. Sahli peut envoyer
  if(users[current].role=="prof" || current=="sahli"){
    h+=`
      <select id="motEleve">
        ${eleves().map(e=>`<option value="${e}">${users[e].name}</option>`).join("")}
      </select>
      <textarea id="motTexte" placeholder="Texte du mot"></textarea>
      <button onclick="envoyerMot()">Envoyer ‚úâÔ∏è</button>
    `;
  }

  h+="<ul id='motsList'></ul>";
  content.innerHTML=h;

  showMots();
}

function showMots(){
  const ul = document.getElementById("motsList");
  if(!ul) return;
  ul.innerHTML="";

  eleves().forEach(e=>{
    const mot = data.mots && data.mots[e] ? data.mots[e] : null;
    if(mot){
      let text = `${users[e].name} : "${mot.texte}" - ${mot.statut}`;

      // Prof ou M. Sahli contr√¥le la poubelle
      if(current=="sahli") text = `<span class="trash" onclick="delMot('${e}')">üóëÔ∏è</span> ` + text;

      // Prof valide/refuse si sign√©
      if((users[current].role=="prof" || current=="sahli") && mot.statut=="Sign√©, en attente validation prof"){
        text+=` <button onclick="valideMot('${e}')">‚úÖ Valider</button>
                <button onclick="refuseMot('${e}')">‚ùå Refuser</button>`;
      }

      // √âl√®ve signe seulement son mot si pas encore sign√©
      if(users[current].role=="eleve" && current==e && mot.statut=="Pas encore sign√©"){
        text+=` <button onclick="signerMot('${e}')">Signer ‚úçÔ∏è</button>`;
      }

      const li = document.createElement("li");
      li.innerHTML = text;
      ul.appendChild(li);
    }
  });
}

function envoyerMot(){
  const e = document.getElementById("motEleve").value;
  const texte = document.getElementById("motTexte").value.trim();
  if(!texte) return alert("√âcrire un mot !");

  if(!data.mots) data.mots={};
  data.mots[e] = {texte:texte, statut:"Pas encore sign√©"};

  save();
  showMots();
}

function signerMot(e){
  if(data.mots && data.mots[e]){
    data.mots[e].statut = "Sign√©, en attente validation prof";
    save();
    showMots();
  }
}

function valideMot(e){
  if(data.mots && data.mots[e]){
    data.mots[e].statut = "Valid√© ‚úÖ";
    save();
    showMots();
  }
}

function refuseMot(e){
  if(data.mots && data.mots[e]){
    data.mots[e].statut = "Refus√© ‚ùå";
    save();
    showMots();
  }
}

function delMot(e){
  if(data.mots && data.mots[e]){
    delete data.mots[e];
    save();
    showMots();
  }
}
</script>
</body>
</html>


